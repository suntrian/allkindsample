@startuml
actor User
box "Conversation Assistant"
participant "Conversation Manager" as CM
participant "Request Analyzer" as RA
participant "OrchestratorAnalyzer" as OA
participant "Agent/Tool" as AG
end box
participant "Kafka" AS KF
participant "OTEL Collector" AS OC
participant "Clickhouse" AS CH

alt "root Span"
activate CM
User -> CM: startConversationRequest
CM -> CM: start root span, setup trace info
CM --> User: startConversationResult({"conversationId: xxx"})

alt  "dialog Span"
User -> CM: generationRequest({"user_input": "hello"})
CM -> CM: set spanAttribute("({"user_input": "hello"})\nadd user message to memory
activate RA
CM -> RA: user message
RA -> RA: analysis intent\nadd analyzer span event
activate OA
RA -> OA: orchestrator task
deactivate RA
activate AG
OA -> AG: call agent
deactivate OA
AG -> AG: add agent span event
AG --> CM: generated response
deactivate AG
CM -> CM: set spanAttribute({"assistant_output": XXX})\nadd assistant message to memory
activate KF
CM -> KF: send trace span
end alt

User -> CM: endConversationRequest
CM --> User
CM -> KF: send end root span
activate OC
KF -> OC: push records
deactivate OC
activate CH
OC -> CH: insert data
deactivate CH
end alt

@enduml